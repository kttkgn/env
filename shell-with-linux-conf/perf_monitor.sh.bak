#!/bin/bash
# 关闭严格模式的-u（避免Mac特殊字符触发未定义变量）
set -eo pipefail  

# 性能监控脚本（MacOS/Linux通用版）
# 使用示例：
# ./perf_monitor.sh --duration 60 --interval 5 --output perf.log

# 初始化参数
DURATION=30
INTERVAL=2
OUTPUT_FILE=""
INTERFACE=""
DISK_PARTITION="/"
DAEMON_MODE=false
START_TIME=$(date +%s)

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
NC='\033[0m'

# 日志函数
log_info() {
    echo -e "${BLUE}[INFO] $(date +"%Y-%m-%d %H:%M:%S") $1${NC}"
}
log_warn() {
    echo -e "${YELLOW}[WARN] $(date +"%Y-%m-%d %H:%M:%S") $1${NC}"
}
log_error() {
    echo -e "${RED}[ERROR] $(date +"%Y-%m-%d %H:%M:%S") $1${NC}"
    exit 1
}

# 解析参数
while [[ $# -gt 0 ]]; do
    case "$1" in
        --duration)
            if ! [[ "$2" =~ ^[1-9][0-9]*$ ]]; then
                log_error "时长必须为正整数，当前值：$2"
            fi
            DURATION="$2"
            shift 2
            ;;
        --interval)
            if ! [[ "$2" =~ ^[1-9][0-9]*$ ]]; then
                log_error "间隔必须为正整数，当前值：$2"
            fi
            INTERVAL="$2"
            shift 2
            ;;
        --output)
            OUTPUT_FILE="$2"
            OUTPUT_DIR=$(dirname "$OUTPUT_FILE")
            if [ ! -d "$OUTPUT_DIR" ] && ! mkdir -p "$OUTPUT_DIR"; then
                log_error "输出目录创建失败：$OUTPUT_DIR"
            fi
            shift 2
            ;;
        --interface)
            INTERFACE="$2"
            shift 2
            ;;
        --disk)
            DISK_PARTITION="$2"
            if ! df -h "$DISK_PARTITION" &>/dev/null; then
                log_error "磁盘分区不存在：$DISK_PARTITION"
            fi
            shift 2
            ;;
        --daemon)
            DAEMON_MODE=true
            shift
            ;;
        --help|-h)
            echo "用法：$0 [选项]"
            echo "选项："
            echo "  --duration <秒>      监控总时长（默认30）"
            echo "  --interval <秒>      采样间隔（默认2）"
            echo "  --output <文件>      输出日志文件路径"
            echo "  --interface <接口>   网络接口（如en0，默认自动检测）"
            echo "  --disk <分区>        监控的磁盘分区（默认/）"
            echo "  --daemon             后台运行模式"
            echo "  --help/-h            显示帮助信息"
            exit 0
            ;;
        *)
            log_error "未知参数：$1（使用--help查看帮助）"
            ;;
    esac
done

# 后台运行处理
if $DAEMON_MODE; then
    log_info "后台运行模式启动，进程ID：$$"
    if [ -z "$OUTPUT_FILE" ]; then
        OUTPUT_FILE="/tmp/perf_monitor_$(date +%Y%m%d_%H%M%S).log"
        log_info "后台模式默认输出文件：$OUTPUT_FILE"
    fi
    nohup "$0" --duration "$DURATION" --interval "$INTERVAL" \
        --output "$OUTPUT_FILE" --interface "$INTERFACE" --disk "$DISK_PARTITION" \
        >/dev/null 2>&1 &
    exit 0
fi

# 自动检测网络接口（适配Mac）
detect_default_interface() {
    if [ -n "$INTERFACE" ]; then
        if ! ip link show "$INTERFACE" &>/dev/null; then
            log_error "指定的网络接口不存在：$INTERFACE"
        fi
        return
    fi

    # Mac优先检测en0，Linux检测eth0/ens33
    local if_list=("en0" "eth0" "ens33" "ens160" "wlan0")
    for iface in "${if_list[@]}"; do
        if ip link show "$iface" &>/dev/null; then
            INTERFACE="$iface"
            return
        fi
    done

    log_warn "未检测到常用网络接口，网络监控功能将禁用"
    INTERFACE=""
}

# 检查依赖（适配MacOS）
check_dependencies() {
    # 必选工具（Mac/Linux兼容）
    local required_tools=("top" "df" "date" "sleep")
    # Mac特有的工具兼容
    if [[ "$(uname -s)" != "Darwin" ]]; then
        required_tools+=("free" "ip")
    fi

    # 检查必选工具
    for tool in "${required_tools[@]}"; do
        if ! command -v "$tool" &>/dev/null; then
            log_error "缺少必选工具：$tool，请安装后重试"
        fi
    done

    # 可选工具（ifstat）
    if ! command -v ifstat &>/dev/null; then
        if [[ "$(uname -s)" == "Darwin" ]]; then
            log_warn "缺少ifstat，网络监控禁用（安装：brew install ifstat）"
        else
            log_warn "缺少ifstat，网络监控禁用（安装：yum/apt install ifstat）"
        fi
    fi
}

# 监控核心函数（Mac/Linux兼容）
monitor() {
    local current_time=$(date +"%Y-%m-%d %H:%M:%S")
    
    # 1. CPU使用率
    local cpu_usage
    if [[ "$(uname -s)" == "Darwin" ]]; then
        # MacOS CPU计算
        cpu_usage=$(top -l 1 | awk '/CPU usage/ {gsub(/%/,""); print 100 - $8}' | cut -d. -f1)
    else
        # Linux CPU计算
        cpu_usage=$(top -bn1 | awk '/^%Cpu/ {print 100 - $8}' | cut -d. -f1)
    fi
    cpu_usage=${cpu_usage:-0}

    # 2. 内存使用率
    local mem_usage="0.0"
    if [[ "$(uname -s)" == "Darwin" ]]; then
        # MacOS内存计算（sysctl+vm_stat）
        local mem_total=$(sysctl hw.memsize | awk '{print $2}')
        local mem_used=$(vm_stat | awk '/Pages active/ {print $3}' | sed 's/\.//')
        mem_used=$((mem_used * 4096))  # 转换为字节（Mac页大小4096）
        mem_usage=$(echo "scale=1; $mem_used / $mem_total * 100" | bc)
    else
        # Linux内存计算
        local mem_total=$(free -b | awk '/Mem/ {print $2}')
        local mem_used=$(free -b | awk '/Mem/ {print $3}')
        mem_usage=$(echo "scale=1; $mem_used / $mem_total * 100" | bc)
    fi
    mem_usage=${mem_usage:-0.0}

    # 3. 磁盘使用率
    local disk_usage
    disk_usage=$(df -h "$DISK_PARTITION" | awk 'NR==2 {gsub("%",""); print $5}')
    disk_usage=${disk_usage:-0}

    # 4. 网络流量
    local net_rx="0" net_tx="0"
    if [ -n "$INTERFACE" ] && command -v ifstat &>/dev/null; then
        local ifstat_output=$(ifstat -i "$INTERFACE" -b -n 1 1 2>/dev/null)
        net_rx=$(echo "$ifstat_output" | awk 'NR==3 {print $1}' | cut -d. -f1)
        net_tx=$(echo "$ifstat_output" | awk 'NR==3 {print $2}' | cut -d. -f1)
        net_rx=$((net_rx / 1024))
        net_tx=$((net_tx / 1024))
    fi

    # 格式化输出
    local output
    output=$(printf "[%s] CPU: %3s%% | 内存: %5s%% | 磁盘(%s): %3s%% | 网络(%s)接收: %5sKB/s | 发送: %5sKB/s" \
        "$current_time" "$cpu_usage" "$mem_usage" "$DISK_PARTITION" "$disk_usage" \
        "$INTERFACE" "$net_rx" "$net_tx")

    echo -e "${GREEN}$output${NC}"
    if [ -n "$OUTPUT_FILE" ]; then
        echo "$output" >> "$OUTPUT_FILE"
    fi
}

# 初始化
check_dependencies
detect_default_interface

# 输出配置信息
log_info "===== 性能监控配置 ====="
log_info "系统类型：$(uname -s)"
log_info "监控时长：${DURATION}秒"
log_info "采样间隔：${INTERVAL}秒"
log_info "磁盘分区：${DISK_PARTITION}"
log_info "网络接口：${INTERFACE:-禁用}"
if [ -n "$OUTPUT_FILE" ]; then
    log_info "输出文件：${OUTPUT_FILE}"
fi
log_info "========================"


# 核心监控循环（删除local关键字 + 修复时间计算）
while true; do
    monitor || log_warn "本次采样出现异常，继续下一次"
    
    current_timestamp=$(date +%s)
    elapsed=$((current_timestamp - START_TIME))
    
    if [ "$elapsed" -ge "$DURATION" ]; then
        break
    fi
    
    # 修复：先执行date +%s获取当前时间戳，再计算差值
    now_timestamp=$(date +%s)
    sample_cost=$((now_timestamp - current_timestamp))  # 采样耗时
    remaining_sleep=$((INTERVAL - sample_cost))         # 剩余休眠时间
    
    if [ "$remaining_sleep" -gt 0 ]; then
        sleep "$remaining_sleep"
    fi
done


log_info "===== 性能监控结束 ====="
if [ -n "$OUTPUT_FILE" ]; then
    log_info "监控日志已保存至：${OUTPUT_FILE}"
fi
